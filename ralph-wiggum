#!/usr/bin/env bash
# ralph-wiggum: "I'm helping!"
# Processes GitHub issues with Claude Code, creates PRs automatically.
set -euo pipefail

RALPH_WIGGUM_REPO="https://github.com/neutronmoderator/ralph-wiggum.git"
SUBMODULE_PATH=".ralph-wiggum"

# Check for gum availability
HAS_GUM=false
if command -v gum &>/dev/null; then
    HAS_GUM=true
fi

# Output helpers with gum fallback
header() {
    if $HAS_GUM; then
        gum style --bold --border double --padding "0 2" --border-foreground 212 "$1"
    else
        echo "=== $1 ==="
    fi
}

info() {
    if $HAS_GUM; then
        gum style --foreground 245 "$1"
    else
        echo "$1"
    fi
}

success() {
    if $HAS_GUM; then
        gum style --foreground 82 "✓ $1"
    else
        echo "✓ $1"
    fi
}

warn() {
    if $HAS_GUM; then
        gum style --foreground 214 "→ $1"
    else
        echo "→ $1"
    fi
}

error() {
    if $HAS_GUM; then
        gum style --foreground 196 "✗ $1"
    else
        echo "✗ $1"
    fi
}

# --- Install command ---
cmd_install() {
    # Check we're in a git repo
    if ! git rev-parse --git-dir &>/dev/null; then
        error "Not in a git repository"
        exit 1
    fi

    # Check if submodule already exists
    if [[ -d "$SUBMODULE_PATH" ]]; then
        error "$SUBMODULE_PATH already exists"
        exit 1
    fi

    info "Installing ralph-wiggum as git submodule..."

    # Add submodule
    git submodule add "$RALPH_WIGGUM_REPO" "$SUBMODULE_PATH"

    # Create wrapper script at project root
    cat > ralph-wiggum <<'EOF'
#!/usr/bin/env bash
# Wrapper for ralph-wiggum submodule
exec "$(dirname "$0")/.ralph-wiggum/ralph-wiggum" "$@"
EOF
    chmod +x ralph-wiggum

    # Update .gitignore if needed (don't ignore the wrapper)
    if [[ -f .gitignore ]]; then
        # Check if ralph-wiggum is ignored and remove it if so
        if grep -q "^ralph-wiggum$" .gitignore 2>/dev/null; then
            warn "'ralph-wiggum' found in .gitignore - you may want to remove it"
        fi
    fi

    echo ""
    success "Installed successfully!"
    echo ""
    info "Files created:"
    info "  $SUBMODULE_PATH/  - git submodule"
    info "  ralph-wiggum      - wrapper script"
    echo ""
    info "Next steps:"
    info "  1. Commit the changes: git add -A && git commit -m 'Add ralph-wiggum'"
    info "  2. Run: ./ralph-wiggum"
}

# --- Run command (default behavior) ---
cmd_run() {
    local open_in_browser=true
    local verbose=false

    # Parse run-specific arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --no-open)
                open_in_browser=false
                shift
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            *)
                error "Unknown option: $1"
                info "Usage: ralph-wiggum run [--no-open] [-v|--verbose]"
                exit 1
                ;;
        esac
    done

    # Check for clean working directory
    if [[ -n "$(git status --porcelain)" ]]; then
        error "Working directory not clean. Commit or stash changes first."
        exit 1
    fi

    # Get default branch name
    default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")

    # Fetch open issues
    if $HAS_GUM; then
        issues=$(gum spin --spinner dot --title "Fetching issues..." -- gh issue list --state open --json number,title,body --limit 20)
    else
        info "Fetching issues..."
        issues=$(gh issue list --state open --json number,title,body --limit 20)
    fi
    total=$(echo "$issues" | jq 'length')

    if [[ "$total" -eq 0 ]]; then
        info "No open issues found."
        exit 0
    fi

    header "Found ${total} open issue(s)"
    echo ""

    # Confirm before processing
    if $HAS_GUM; then
        if ! gum confirm "Process these issues with Claude Code?"; then
            info "Cancelled."
            exit 0
        fi
        echo ""
    fi

    # Track stats
    created=0
    skipped=0
    nochange=0
    i=0

    # Process each issue
    echo "$issues" | jq -c '.[]' | while read -r issue; do
        ((i++)) || true
        number=$(echo "$issue" | jq -r '.number')
        title=$(echo "$issue" | jq -r '.title')
        body=$(echo "$issue" | jq -r '.body // ""')
        branch="issue-${number}"

        if $HAS_GUM; then
            gum style --bold "[${i}/${total}] Issue #${number}: ${title}"
        else
            echo "[${i}/${total}] Issue #${number}: ${title}"
        fi

        # Skip if branch already exists
        if git branch -a 2>/dev/null | grep -qE "(^|\s)${branch}$|origin/${branch}$"; then
            warn "Skipping (branch already exists)"
            ((skipped++)) || true
            echo ""
            continue
        fi

        # Ensure we're on default branch and up to date
        info "  Creating branch ${branch}..."
        git checkout "$default_branch" --quiet
        git pull --ff-only --quiet 2>/dev/null || true
        git checkout -b "$branch" --quiet

        # Build prompt
        prompt="GitHub Issue #${number}: ${title}

${body}

---
Implement the changes requested in this issue. Make minimal, focused changes."

        # Run Claude Code
        info "  Running Claude Code..."
        if $verbose; then
            echo "      ┌─────────────────────────────────────"
            echo "$prompt" | claude -p --dangerously-skip-permissions 2>&1 | sed 's/^/      │ /' || {
                echo "      └─────────────────────────────────────"
                error "Claude Code failed, cleaning up..."
                git checkout "$default_branch" --quiet
                git branch -D "$branch" --quiet 2>/dev/null || true
                echo ""
                continue
            }
            echo "      └─────────────────────────────────────"
        elif $HAS_GUM; then
            if ! echo "$prompt" | gum spin --spinner dot --title "Claude Code processing #${number}..." -- claude -p --dangerously-skip-permissions; then
                error "Claude Code failed, cleaning up..."
                git checkout "$default_branch" --quiet
                git branch -D "$branch" --quiet 2>/dev/null || true
                echo ""
                continue
            fi
        else
            # Stream JSON and show progress indicators
            echo "$prompt" | claude -p --dangerously-skip-permissions --output-format stream-json 2>&1 | \
            while IFS= read -r line; do
                type=$(echo "$line" | jq -r '.type // empty' 2>/dev/null)
                case "$type" in
                    assistant)
                        # Show a dot for each assistant message chunk
                        printf "." >&2
                        ;;
                    result)
                        # Show final result summary
                        printf "\n" >&2
                        ;;
                esac
            done || {
                echo ""
                error "Claude Code failed, cleaning up..."
                git checkout "$default_branch" --quiet
                git branch -D "$branch" --quiet 2>/dev/null || true
                echo ""
                continue
            }
        fi

        # Check if any changes were made
        if git diff --quiet && git diff --cached --quiet; then
            warn "No changes made"
            git checkout "$default_branch" --quiet
            git branch -D "$branch" --quiet
            ((nochange++)) || true
            echo ""
            continue
        fi

        # Commit changes
        info "  Committing changes..."
        git add -A
        git commit --quiet -m "fix: address issue #${number}

${title}"

        # Push and create PR
        info "  Creating PR..."
        if $HAS_GUM; then
            gum spin --spinner dot --title "Pushing branch..." -- git push -u origin "$branch" --quiet 2>&1
        else
            git push -u origin "$branch" --quiet 2>&1
        fi
        pr_url=$(gh pr create \
            --title "Fix #${number}: ${title}" \
            --body "Closes #${number}

Automated implementation by Claude Code." \
            --head "$branch" 2>&1)

        ((created++)) || true
        success "PR created: ${pr_url}"
        echo "$pr_url" >> /tmp/ralph-wiggum-prs-$$
        echo ""

        # Return to default branch
        git checkout "$default_branch" --quiet
    done

    # Summary
    echo ""
    if $HAS_GUM; then
        gum style --border double --padding "0 2" --border-foreground 212 "Summary"
        gum format -- "| Result | Count |" "|--------|-------|" "| $(gum style --foreground 82 'PRs Created') | ${created} |" "| $(gum style --foreground 214 'Skipped') | ${skipped} |" "| $(gum style --foreground 245 'No Changes') | ${nochange} |"
    else
        echo "---"
        echo "Done: ${created} PRs created, ${skipped} skipped, ${nochange} no changes"
    fi

    # Open PRs in browser if requested
    pr_file="/tmp/ralph-wiggum-prs-$$"
    if [[ -f "$pr_file" ]]; then
        if [[ "$open_in_browser" == true ]]; then
            echo ""
            info "Opening PRs in browser..."
            while read -r url; do
                gh pr view "$url" --web 2>/dev/null || true
            done < "$pr_file"
        fi
        rm -f "$pr_file"
    fi
}

# --- Main ---
case "${1:-run}" in
    install)
        cmd_install
        ;;
    run|"")
        shift 2>/dev/null || true
        cmd_run "$@"
        ;;
    -h|--help|help)
        header "ralph-wiggum"
        echo ""
        info "Process GitHub issues with Claude Code"
        echo ""
        info "Usage:"
        info "  ralph-wiggum [command] [options]"
        echo ""
        info "Commands:"
        info "  run      Process open issues (default)"
        info "  install  Add ralph-wiggum to a repo as a git submodule"
        info "  help     Show this help"
        echo ""
        info "Run options:"
        info "  --no-open     Don't open PRs in browser after creation"
        info "  -v|--verbose  Show full Claude Code output"
        ;;
    *)
        error "Unknown command: $1"
        info "Run 'ralph-wiggum help' for usage"
        exit 1
        ;;
esac
